<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Mobile Admin - iPad Show Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* HEADER */
        .header {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 1rem;
            border-bottom: 2px solid #4a9eff;
            text-align: center;
        }

        .header h1 {
            font-size: 1.3rem;
            color: #4a9eff;
            margin-bottom: 0.25rem;
        }

        .header p {
            font-size: 0.75rem;
            color: #999;
        }

        /* CONNECTION STATUS */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4a9eff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* MAIN CONTENT */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 0;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab.active {
            background: #4a9eff;
            color: #000;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* SCENE GRID - LARGE BUTTONS */
        .scenes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .scene-btn {
            background: linear-gradient(135deg, #252525 0%, #1a1a1a 100%);
            border: 2px solid #444;
            padding: 1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            touch-action: manipulation;
        }

        .scene-btn:active {
            background: linear-gradient(135deg, #4a9eff 0%, #2f7ecf 100%);
            color: #000;
            border-color: #4a9eff;
            transform: scale(0.95);
        }

        .scene-btn:hover {
            border-color: #4a9eff;
        }

        .scene-label {
            font-size: 0.95rem;
            line-height: 1.2;
        }

        .scene-category {
            font-size: 0.7rem;
            color: #999;
            opacity: 0.7;
        }

        /* TEST SYNC BUTTON */
        .test-button {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            border: none;
            padding: 1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
            width: 100%;
            touch-action: manipulation;
        }

        .test-button:active {
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.4);
        }

        /* DEVICE STATUS */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .device-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .device-card.connected {
            border-color: #4a9eff;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .device-card.disconnected {
            opacity: 0.5;
            border-color: #ff6b6b;
        }

        .device-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .device-status {
            font-size: 0.8rem;
            color: #999;
        }

        .device-status.connected {
            color: #4a9eff;
        }

        .device-status.disconnected {
            color: #ff6b6b;
        }

        /* QUICK ACTIONS */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .action-btn {
            background: linear-gradient(135deg, #252525 0%, #1a1a1a 100%);
            border: 2px solid #444;
            padding: 0.75rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .action-btn:active {
            background: linear-gradient(135deg, #333 0%, #252525 100%);
            border-color: #4a9eff;
        }

        .action-btn.danger {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .action-btn.danger:active {
            background: #ff6b6b;
            color: #000;
        }

        /* CONTENT SENDER */
        .content-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .form-group label {
            font-weight: 600;
            color: #4a9eff;
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select {
            background: #252525;
            border: 2px solid #444;
            color: #fff;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a9eff;
            background: #1f2b3d;
        }

        .send-btn {
            background: linear-gradient(135deg, #4a9eff 0%, #2f7ecf 100%);
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            color: #000;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* FOOTER */
        .footer {
            padding: 1rem;
            border-top: 1px solid #333;
            background: #1a1a1a;
            text-align: center;
            font-size: 0.75rem;
            color: #666;
        }

        /* RESPONSIVE */
        @media (max-width: 480px) {
            .scenes-grid,
            .device-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .content {
                padding: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <div class="header">
        <h1>üé¨ Control</h1>
        <p id="connectionStatus">Connecting...</p>
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-indicator">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Disconnected</span>
        </div>
        <span id="deviceCountText">0/0 devices</span>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content">
        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scenes')">‚ö° Scenes</button>
            <button class="tab" onclick="switchTab('devices')">üì± Devices</button>
            <button class="tab" onclick="switchTab('control')">üéÆ Control</button>
        </div>

        <!-- SCENES TAB -->
        <div class="tab-content active" id="scenesTab">
            <button class="test-button" onclick="startTestSync()">üß™ Test Sync</button>
            <div class="scenes-grid" id="scenesGrid"></div>
        </div>

        <!-- DEVICES TAB -->
        <div class="tab-content" id="devicesTab">
            <div class="device-grid" id="deviceGrid"></div>
        </div>

        <!-- CONTROL TAB -->
        <div class="tab-content" id="controlTab">
            <div class="content-form">
                <div class="form-group">
                    <label>Content Type</label>
                    <select id="contentType" onchange="updateContentForm()">
                        <option value="color">Color</option>
                        <option value="image">Image URL</option>
                        <option value="video">Video URL</option>
                        <option value="text">Text</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Value</label>
                    <input type="text" id="contentValue" placeholder="Enter value..." />
                </div>

                <button class="send-btn" onclick="sendCustomContent()">Send to All</button>
            </div>

            <div class="quick-actions">
                <button class="action-btn" onclick="fallbackAll()">üõë Fallback</button>
                <button class="action-btn" onclick="reloadDevices()">üîÑ Reload</button>
                <button class="action-btn danger" onclick="emergencyStop()">‚ö†Ô∏è EMERGENCY</button>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
         <p>Site cr√©e par <a href="https://ayox.dev/" style="color: white;">RIGOLET Il√Øas</a></p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let state = {
            scenes: [],
            devices: {},
            selectedDeviceIds: new Set(),
            isConnected: false
        };

        // Initialize
        function init() {
            initSocket();
            loadInitialData();
        }

        // Socket.IO
        function initSocket() {
            socket = io({
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                state.isConnected = true;
                updateConnectionStatus();
            });

            socket.on('disconnect', () => {
                state.isConnected = false;
                updateConnectionStatus();
            });

            socket.on('device-status-update', (devices) => {
                state.devices = devices;
                updateDeviceStatus();
            });

            socket.on('scene-triggered', (data) => {
                console.log('Scene triggered:', data);
            });
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const [scenesRes, devicesRes] = await Promise.all([
                    fetch('/api/scenes'),
                    fetch('/api/devices')
                ]);

                state.scenes = await scenesRes.json();
                state.devices = await devicesRes.json();

                renderScenes();
                updateDeviceStatus();
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (state.isConnected) {
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        // Update device status
        function updateDeviceStatus() {
            const grid = document.getElementById('deviceGrid');
            const connectedCount = Object.values(state.devices).filter(d => d?.isConnected).length;
            const totalCount = Object.keys(state.devices).length;

            document.getElementById('deviceCountText').textContent = `${connectedCount}/${totalCount} devices`;

            grid.innerHTML = Object.entries(state.devices).map(([id, device]) => `
                <div class="device-card ${device?.isConnected ? 'connected' : 'disconnected'}">
                    <div class="device-name">${device?.label || id}</div>
                    <div class="device-status ${device?.isConnected ? 'connected' : 'disconnected'}">
                        ${device?.isConnected ? 'üü¢ Connected' : 'üî¥ Disconnected'}
                    </div>
                </div>
            `).join('');
        }

        // Render scenes
        function renderScenes() {
            const grid = document.getElementById('scenesGrid');

            // Group by category
            const byCategory = {};
            state.scenes.forEach(scene => {
                const cat = scene.category || 'Autres';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(scene);
            });

            let html = '';
            const order = ['D√©but/Fin', 'Contenu', 'Transitions', 'Tests', 'Autres'];

            order.forEach(category => {
                if (byCategory[category]) {
                    byCategory[category].forEach(scene => {
                        html += `
                            <button class="scene-btn" onclick="triggerScene('${scene.id}')">
                                <span class="scene-label">${scene.label || scene.id}</span>
                                <span class="scene-category">${category}</span>
                            </button>
                        `;
                    });
                }
            });

            Object.keys(byCategory).forEach(category => {
                if (!order.includes(category)) {
                    byCategory[category].forEach(scene => {
                        html += `
                            <button class="scene-btn" onclick="triggerScene('${scene.id}')">
                                <span class="scene-label">${scene.label || scene.id}</span>
                                <span class="scene-category">${category}</span>
                            </button>
                        `;
                    });
                }
            });

            grid.innerHTML = html;
        }

        // Trigger scene
        async function triggerScene(sceneId) {
            try {
                await fetch(`/api/scene/${sceneId}`, { method: 'POST' });
            } catch (err) {
                console.error('Error triggering scene:', err);
            }
        }

        // Start test sync
        async function startTestSync() {
            const testScenes = ['test_sync_red', 'test_sync_green', 'test_sync_blue', 'test_sync_white', 'scene_black_screen'];
            for (const sceneId of testScenes) {
                await triggerScene(sceneId);
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }

        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(el => {
                el.classList.remove('active');
            });

            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Update content form
        function updateContentForm() {
            const type = document.getElementById('contentType').value;
            const input = document.getElementById('contentValue');

            switch (type) {
                case 'color':
                    input.type = 'color';
                    input.placeholder = 'Color';
                    input.value = '#000000';
                    break;

                case 'image':
                case 'video':
                    input.type = 'text';
                    input.placeholder = 'Enter URL...';
                    break;

                case 'text':
                    input.type = 'text';
                    input.placeholder = 'Enter text...';
                    break;
            }
        }

        // Send custom content
        async function sendCustomContent() {
            const type = document.getElementById('contentType').value;
            const value = document.getElementById('contentValue').value;
            const deviceIds = Object.keys(state.devices);

            const content = {
                type,
                [type === 'color' ? 'value' : 'src']: value
            };

            try {
                await fetch('/api/content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceIds, content })
                });
            } catch (err) {
                console.error('Error sending content:', err);
            }
        }

        // Fallback
        async function fallbackAll() {
            try {
                await fetch('/api/all/fallback', { method: 'POST' });
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Reload devices
        async function reloadDevices() {
            try {
                const res = await fetch('/api/devices');
                state.devices = await res.json();
                updateDeviceStatus();
            } catch (err) {
                console.error('Error reloading devices:', err);
            }
        }

        // Emergency stop
        function emergencyStop() {
            if (confirm('‚ö†Ô∏è Emergency stop all displays?')) {
                fallbackAll();
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
